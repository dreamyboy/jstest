<!DOCTYPE html>
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->

<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->

<head>

    <meta charset="utf-8">

    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">

    <title>Next Bus NSW</title>
    <style type="text/css">
        html,body{margin:0;padding:0;width:100%;height:100%;}
        body{font-family:sans-serif;}
        #header{z-index:1;position:absolute;top:0;height:38px;width:100%;background:#9dd53a;background:-moz-linear-gradient(top,#9dd53a 0%,#a1d54f 50%,#80c217 51%,#7cbc0a 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0%,#9dd53a),color-stop(50%,#a1d54f),color-stop(51%,#80c217),color-stop(100%,#7cbc0a));}
        #footer{z-index:1;position:absolute;bottom:0;width:100%;height:43px;border-top:1px solid #333;border-bottom:1px solid #000;background:#000;background:#000 -webkit-gradient(linear,left bottom,left top,color-stop(0,rgb(0,0,0)),color-stop(0.5,rgb(0,0,0)),color-stop(0.51,rgb(21,21,21)),color-stop(0.9,rgb(62,62,62)));background:#8e5b3e -moz-linear-gradient(center bottom,rgb(62,62,62) 90%,rgb(21,21,21) 51%,rgb(0,0,0) 50%,rgb(0,0,0) 0%);text-align:center;}
        .scroll-frame{position:absolute;top:38px;overflow-y:scroll;bottom:45px;width:100%;}
        #header h1{font-size:20px;position:absolute;left:50%;font-weight:bold;text-shadow:rgb(33,33,33) 0px 1px 0;text-align:center;text-overflow:ellipsis;white-space:nowrap;margin:7px 0 0 -95px;height:45px;width:190px;overflow:hidden;color:#fff;font-family:'Yanone Kaffeesatz',arial,serif;}
        #header .button{position:absolute;overflow:hidden;top:3px;margin:0;padding:0 3px;width:auto;height:30px;line-height:30px;font-family:inherit;font-size:12px;font-weight:bold;color:#fff;text-shadow:rgba(0,0,0,0.6) 0 -1px 0;text-overflow:ellipsis;text-decoration:none;white-space:nowrap;border:1px solid rgba(15,18,34,0.4);-webkit-border-radius:4px;}
        #header .button-active{background:#172555;background:#172555 -webkit-gradient( linear,left bottom,left top,color-stop(0,rgb(23,37,85)),color-stop(0.5,rgb(23,37,85)),color-stop(0.51,rgb(39,53,99)),color-stop(0.9,rgb(91,101,126)) );background:#172555 -moz-linear-gradient( center bottom,rgb(91,101,126) 90%,rgb(39,53,99) 51%,rgb(23,37,85) 50%,rgb(23,37,85) 0% );border:1px solid rgba(15,18,34,0.5);}
        #header .button-right{right:6px;}
        #header .button-left{left:6px;}
        #my-location span{font-size:23px !important;padding:0 4px;}
        #map-wrapper{height:100%;width:100%;top:38px;position:absolute;}
        .ie6 #map-canvas,.ie7 #map-canvas{height:500px;}
        #map-canvas,#buses{height:100%;width:100%;position:relative;}
        #buses-wrapper{display:none;}
        #loc,#load{width:16px;height:16px;}
        #load{display:none;}
        #footer{line-height:43px;}
        #footer .button{margin:0;padding:7px;width:auto;height:30px;line-height:30px;font-family:inherit;font-size:12px;font-weight:bold;color:#fff;text-shadow:rgba(0,0,0,0.6) 0 -1px 0;text-overflow:ellipsis;text-decoration:none;white-space:nowrap;border:1px solid rgba(15,18,34,0.5);border-left:0;}
        #footer .button-left{-webkit-border-top-left-radius:4px;-webkit-border-bottom-left-radius:4px;border:1px solid rgba(15,18,34,0.5);}
        #footer .button-right{-webkit-border-top-right-radius:4px;-webkit-border-bottom-right-radius:4px;border:1px solid rgba(15,18,34,0.5);border-left:0;}
        #footer .button-both{-webkit-border-radius:4px;border:1px solid rgba(15,18,34,0.5);}
        #footer .button-active{background:#4c4c4c;background:#4c4c4c -webkit-gradient( linear,left bottom,left top,color-stop(0,rgb(37,37,37)),color-stop(0.5,rgb(36,36,36)),color-stop(0.51,rgb(54,54,54)),color-stop(0.9,rgb(76,76,76)) );background:#4c4c4c -moz-linear-gradient( center bottom,rgb(76,76,76) 90%,rgb(54,54,54) 51%,rgb(36,36,36) 50%,rgb(37,37,37) 0% );}
        #buses ul{margin:0;padding:0;}
        #buses li{clear:both;list-style:none;border-bottom:1px solid #eee;padding:10px;overflow:hidden;background:-moz-linear-gradient(top,#ffffff 0%,#f6f6f6 47%,#ededed 100%);background:-webkit-gradient(linear,left top,left bottom,color-stop(0%,#ffffff),color-stop(47%,#f6f6f6),color-stop(100%,#ededed));position:relative;}
        #buses li span{}
        #buses li span.route{font-weight:bold;padding-right:8px;}
        #buses li span.dest{}
        .route-info{padding-top:5px;}
        .route-info,.stopdesc{margin-left:75px;line-height:18px;}
        .arrival{float:left;height:40px;width:60px;font-size:2em;padding-left:5px;line-height:40px;}
        .arrival span{color:#666;font-weight:normal;font-size:0.75em;font-family:"HelveticaNeue-UltraLight","Helvetica Neue UltraLight","Helvetica Neue",sans-serif;font-weight:100;}
        .stopdesc{color:#666;font-size:0.9em;font-family:"HelveticaNeue-Light","Helvetica Neue Light","Helvetica Neue",sans-serif;}
        #refresh{display:none;}
        #refresh span{display:block;width:16px;height:16px;}
        #refresh span,#my-location span{font-size:23px !important;padding:0 4px;}
        #header,#footer{-webkit-transition:all .1s ease-in;}
        #about{display:none;}
        #about h1{font-size:20px;}
        #about p{padding:0 5px;}
        #alert{width:90%;text-align:center;position:absolute;bottom:65px;left:5%;padding:5px;border-radius:10px;border:1px solid red;background:rgba(255,255,255,.8);color:red;z-index:999;font-size:.8em;}
        img a{border:none;}
        #buses li.realtime span.icon{display:block;position:absolute;right:5px;top:0;height:100%;width:16px;background-image:url('geolocation_icon.png');background-repeat:no-repeat;background-position:right center;opacity:.5;}
    </style>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>

    <script src="http://maps.google.com/maps/api/js?sensor=false"></script>

    <script src="scroller.js" type="text/javascript"></script>


</head>

<body>

<div id="header">

    <h1>Next Bus</h1>

    <a href="#" class="button button-right" id="refresh">
 
      <span>
 
        <img src="static/icon_refresh.png">
 
      </span>

    </a>

    <a href="#" class="button button-right" id="my-location">
 
      <span>
 
        <img src="static/geolocation_icon.png" id="loc"/>
 
        <img src="static/ajax-loader.gif" id="load"/>
 
      </span>

    </a>

</div>



<div id="map-wrapper">

    <div id="map-canvas"></div>

</div>



<div id="buses-wrapper" class="scroll-frame">

    <div class="scrollable">

        <div id="buses"><ul></ul></div>

    </div>

</div>



<div id="about" class="scroll-frame">

    <div class="scrollable">

        <h1>About Next Bus</h1>

        <p>

            Next Bus was created in a day (19 February 2011) by

            <a href="http://twitter.com/broady">Chris Broadfoot</a>

            and <a href="http://twitter.com/lukemahe">Luke Mahe</a> as part of the

            <a href="http://apps4nsw.webdirections.org/">apps4nsw</a> hack day.

        </p>

        <p>

            It won first place in the Transport category, as well as first

            place overall.

        </p>

        <p>

            It uses live bus data provided by the RTA available at

            <a href="http://data.nsw.gov.au/">data.nsw.gov.au</a>.

        </p>

        <ul>

            <li><a href="http://code.google.com/p/next-bus/source/browse/#svn%2Ftrunk">Source</a></li>

            <li><a href="http://code.google.com/p/next-bus/issues/list">Bugs</a></li>

        </ul>

        <p>

            <strong>Disclaimer:</strong>

            The accuracy or suitability of the Data is not verified and it is provided on an &ldquo;as is&rdquo; basis.

        </p>

    </div>

</div>



<div id="footer">

    <a href="#" class="button button-left button-active" id="btn-map">Map</a><a href="#" class="button" id="btn-buses">Next Buses</a><a href="#" class="button button-right" id="btn-about">About</a>

</div>
<script type="text/javascript">
    var Scroller = function (element,topLimit,bottomLimit,backTime) {
        this.element = element;
        this.startTouchY = 0;
        this.topLimit = topLimit || 0;
        this.bottomLimit = bottomLimit || 500;
        this.backTime = backTime || 500;
        this.animateTo(0); //设置起点为0
        var box = element.parentNode;
        if (~navigator.userAgent.indexOf('Mobile')) { //测试用
            document.body.addEventListener('touchstart', this.handleEvent.bind(this), false);
            document.body.addEventListener('touchmove', this.handleEvent.bind(this), false);
            document.body.addEventListener('touchend', this.handleEvent.bind(this), false);
        } else {
            document.body.addEventListener('mousedown', this.handleEvent.bind(this), false);
            document.body.addEventListener('mousemove', this.handleEvent.bind(this), false);
            document.body.addEventListener('mouseup', this.handleEvent.bind(this), false);
        }
    }


    Scroller.prototype.handleEvent = function (e) {
        var _self = this;
        switch (e.type) {
            case 'touchstart':
                _self.onTouchStart(e);
                break;
            case 'touchmove':
                _self.onTouchMove(e);
                break;
            case 'touchend':
                _self.onTouchEnd(e);
                break;
            case 'mouseup':
                _self.onTouchEnd(e);
                break;
            case 'mousemove':
                _self.onTouchMove(e);
                break;
            case 'mousedown':
                _self.onTouchStart(e);
                break;
        }
    }


    Scroller.prototype.onTouchStart = function (e) {
        this.stopMomentum();
        this.startTime = +new Date();
        this.touching = true;
        if (e.touches) {
            this.startTouchY = e.touches[0].clientY;//触摸起点
        } else {
            this.startTouchY = e.clientY;
        }
        this.contentStartOffsetY = this.currentOffsetY;
    }


    Scroller.prototype.onTouchMove = function (e) {
        if(this.touching){


            if (e.touches) {
                var currentY = e.touches[0].clientY;//手指触摸终点
            } else {
                var currentY = e.clientY;
            }
            var deltaY = currentY - this.startTouchY; //触摸距离
            var newY = deltaY + this.contentStartOffsetY; //起点加距离为终点
            this.animateTo(newY);


        }






    }


    Scroller.prototype.onTouchEnd = function (e) {
        if(this.touching){
            console.log('touchEnd!!!')
            this.touching = false;
            this.doMomentum(e);
        }
    }


    Scroller.prototype.animateTo = function (offsetY) { //驱动元素位移
        this.currentOffsetY = offsetY;
        //	console.log(this.currentOffsetY)
        // 在 webkit-transforms用 translate3d 的动画会得到硬件加速,性能显著提高
        this.element.style.webkitTransform = 'translate3d(0, ' + offsetY + 'px, 0)';
    }




    Scroller.prototype.backToTop = function () { //返回最顶部·
        this.moveTo(this.topLimit,this.backTime)
    }




    Scroller.prototype.backTobottom = function () { //返回最底部
        this.moveTo(-this.bottomLimit,this.backTime)
    }


    Scroller.prototype.moveTo = function(offsetY,time) {
        this.contentOffsetY = offsetY;


        this.element.style.webkitTransition = '-webkit-transform ' + time +// 设置好 transition执行 transform.
                'ms cubic-bezier(0.33, 0.66, 0.66, 1)';
        this.element.style.webkitTransform = 'translate3d(0, ' + offsetY + 'px, 0)';
    };




    Scroller.prototype.doMomentum = function (e) {

        //console.log(this.currentOffsetY,this.topLimit,this.bottomLimit)
        if(this.currentOffsetY >this.topLimit){
            this.backToTop();
            return
        }else if(Math.abs(this.currentOffsetY) >this.bottomLimit){
            this.backTobottom();
            return
        }


        // 计算移动距离. 通过 开始位置和时间的比值来实现getEndVelocity方法
        var velocity = this.getEndVelocity(e); //拿到抬起手指时的速度


        //console.log(' v : ' + velocity)


        var acceleration = velocity < 0 ? 20 : -20; //加速度
        var displacement =  - (velocity * velocity) / (2 * acceleration); //惯性距离(s = vot - 0.5at2),t = vo/a




        //推导得 s = vo方/2a
        var time =  - velocity / acceleration; //运动时间


        var newY = this.currentOffsetY + displacement; //设置终点


        this.moveTo(newY,time*200)


    };


    Scroller.prototype.stopMomentum = function () {
        // 获取样式对象.
        var style = document.defaultView.getComputedStyle(this.element, null);
        // 使用所得样式值通过webkitCSSMatrix计算出当前transform值.
        var transform = new WebKitCSSMatrix(style.webkitTransform);
        // 清除transition以免作用到下一个transform.


        //console.log('element!'+this.element,this.element.style.webkitTransition)
        this.element.style.webkitTransition = '';
        //	console.log('element!'+this.element,this.element.style.webkitTransition)
        // 指定transform到目标位置.
        this.animateTo(transform.m42);
    }


    Scroller.prototype.getEndVelocity = function (e) { //计算惯性
        this.endTime = +new Date();
        if (e.touches) {
            var clientY = e.touches[0].clientY;//终点
        } else {
            var clientY = e.clientY;
        }
        var velocity = (clientY - this.startTouchY) / (this.endTime - this.startTime)*100 // 计算速度
        return velocity;
    };

    new Scroller(document.getElementById('footer'));
</script>
</body>

</html> 
